## Database Migrations with Alembic

### Initial Setup

1. Install Alembic using Poetry:
```bash
poetry add alembic
```

2. Initialize Alembic:
```bash
poetry run alembic init migrations
```

3. Configure `alembic.ini`:
```ini
# Update sqlalchemy.url
sqlalchemy.url = postgresql://%(DB_USER)s:%(DB_PASSWORD)s@%(DB_HOST)s:%(DB_PORT)s/%(DB_NAME)s
```

4. Update `migrations/env.py`:
```python
# Add these imports
from auth_service.database import Base
from auth_service import models
import os
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Update config section
config.set_main_option("sqlalchemy.url", 
    f"postgresql://{os.getenv('DB_USER')}:{os.getenv('DB_PASSWORD')}@"
    f"{os.getenv('DB_HOST')}:{os.getenv('DB_PORT')}/{os.getenv('DB_NAME')}"
)

# Add this line to include your models
target_metadata = Base.metadata
```

### Working with Migrations

1. Create a new migration:
```bash
# Generate migration with a message
poetry run alembic revision --autogenerate -m "describe your changes"
```

2. Apply migrations:
```bash
# Apply all pending migrations
poetry run alembic upgrade head

# Apply specific migration
poetry run alembic upgrade <revision_id>

# Rollback one migration
poetry run alembic downgrade -1

# Rollback to specific migration
poetry run alembic downgrade <revision_id>
```

3. Check migration status:
```bash
# View current migration state
poetry run alembic current

# View migration history
poetry run alembic history
```

### Best Practices

1. Always review autogenerated migrations before applying
2. Test migrations on development database first
3. Include both upgrade and downgrade operations
4. Use meaningful migration messages
5. Keep migrations small and focused
6. Version control your migrations

### Common Commands

```bash
# Create new migration
poetry run alembic revision --autogenerate -m "add user table"

# Apply all migrations
poetry run alembic upgrade head

# Rollback last migration
poetry run alembic downgrade -1

# View migration SQL
poetry run alembic upgrade head --sql

# View pending migrations
poetry run alembic history --indicate-current
```

### Troubleshooting

- If migrations fail, check:
  - Database connection settings
  - Model imports in env.py
  - Migration dependencies
  - Database permissions
  - Existing data constraints

- To reset migrations:
  1. Drop all tables
  2. Delete migration versions
  3. Create new initial migration
  4. Run upgrade